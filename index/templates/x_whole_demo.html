<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">

    <title>主页-瀚海星云BBS</title>

    <meta name="keywords" content="">
    <meta name="description" content="">

    <!--[if lt IE 9]>
    <meta http-equiv="refresh" content="0;ie.html" />
    <![endif]-->
    {% load static %}
    <link rel="shortcut icon" href="{% static "img/ustc.png" %}">
    <link href="{% static "css/bootstrap.min.css" %}" rel="stylesheet">
    <link href="{% static "css/font-awesome.min.css" %}" rel="stylesheet">
    <link href="{% static "css/animate.css" %}" rel="stylesheet">
    <link href="{% static "css/style.css" %}" rel="stylesheet">
</head>

<body class="fixed-sidebar full-height-layout gray-bg" style="overflow:hidden;">
    <div id="wrapper">
        <!--左侧导航开始-->

        <nav class="navbar-default navbar-static-side" role="navigation">
            <div class="nav-close"><i class="fa fa-times-circle"></i>
            </div>
            <div class="sidebar-collapse" style="background-color:#FFFFFF ">
                <ul class="nav" id="side-menu" >
                    <li class="nav-header" style="background: #0e9aef;background: url('/static/css/patterns/header-profile-skin-1.png');">
                        <div class="dropdown profile-element">
                            <a href="{% url "view_self_info" %}">
                                <span class="boxT"><img alt="image" class="img-circle" src="{% get_media_prefix %}{{ user.portrait }}" /></span>
                            </a>

                            <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                                <span class="clear" style="color:black;">
                               <span class="block m-t-xs"><strong class="font-bold">用戶</strong></span>
                                <span class="text-muted text-xs block" style="color:black;">{{ user.username }}<b class="caret"></b></span>
                                </span>
                            <ul class="dropdown-menu animated fadeInRight m-t-xs " style="color:black;">
                                <li><a class="J_menuItem" href="{% url "view_self_info" %}" style="color:black;">个人页面</a>
                                </li>
{#                                <li><a class="J_menuItem" href="x_mailbox_demo.html" style="color:black;">信箱</a>#}
{#                                </li>#}
                                <li class="divider"></li>
                                <li><a href="{% url "logout" %}" style="color:black;">安全退出</a>
                                </li>
                            </ul>
                            </a>
                        </div>
                        <div class="logo-element">瀚海
                        </div>
                    </li>
                    <li>
                        <a href="#">
                            <i class="fa fa-bookmark"></i>
                            <span class="nav-label" style="color:black;">版面收藏栏</span>
                            <span class="fa arrow"></span>
                        </a>
                        <ul class="nav nav-second-level" style="background: #FFFFFF">
                            <li>
                                <a class="J_menuItem" style="color:black;" href="x_bankuai_demo.html" data-index="0" >A区</a>
                            </li>
                            <li>
                                <a class="J_menuItem" style="color:black;" href="x_bankuai_demo.html">B区</a>
                            </li>
                            <li>
                                <a class="J_menuItem" style="color:black;" href="x_bankuai_demo.html">C区</a>
                            </li>
                            <li>
                                <a class="J_menuItem" style="color:black;" href="x_bankuai_demo.html">D区</a>
                            </li>

                        </ul>

                    </li>

                    <li>
                        <a href="#">
                            <i class="fa fa fa-book"></i>
                            <span class="nav-label" style="color:black;" >版面目录</span>
                            <span class="fa arrow"></span>
                        </a>
                        <ul class="nav nav-second-level" style="background: #FFFFFF">
                            <li>
                                <a class="J_menuItem" style="color:black;" href="x_bankuai_demo.html" data-index="0">A区</a>
                            </li>
                            <li>
                                <a class="J_menuItem" style="color:black;" href="x_bankuai_demo.html">B区</a>
                            </li>
                            <li>
                                <a class="J_menuItem" style="color:black;" href="x_bankuai_demo.html">C区</a>
                            </li>
                            <li>
                                <a class="J_menuItem" style="color:black;" href="x_bankuai_demo.html">D区</a>
                            </li>
                        </ul>
                    </li>

{#                    <li>#}
{#                        <a href="x_mailbox_demo.html">#}
{#                            <i class="fa fa-envelope"></i>#}
{#                            <span class="nav-label" style="color:black;">信箱</span>#}
{#                            <span class="fa arrow"></span>#}
{#                        </a>#}
{#                        <ul class="nav nav-second-level" style="background: #FFFFFF">#}
{#                            <li><a class="J_menuItem" href="x_mailbox_demo.html" style="color:black;" >收件箱<span class="label label-warning pull-right">16</span></a>#}
{#                            </li>#}
{#                            <li><a class="J_menuItem" href="x_mail_send_demo.html" style="color:black;">发信息</a>#}
{#                            </li>#}
{#                        </ul>#}
{#                    </li>#}

                    <li>
                        <a href="#" >
                            <i class="fa fa-heart"></i>
                            <span class="nav-label" style="color: black;">关注的人</span>
                            <span class="fa arrow"></span>
                        </a>
                        <ul class="nav nav-second-level" style="background: #FFFFFF">
                            <ui class="project-people">
                                <a class="J_menuItem" href="x_personal_page_show_demo.html" title="ZH" >
                                    <img alt="image" class="img-circle" src="{% static "img/a3.jpg" %}">
                                </a>
                                <a class="J_menuItem" href="x_personal_page_show_demo.html" title="MRC">
                                    <img alt="image" class="img-circle" src="{% static "img/a1.jpg" %}">
                                </a>
                                <a class="J_menuItem" href="x_personal_page_show_demo.html" title="ZR">
                                    <img alt="image" class="img-circle" src="{% static "img/a2.jpg" %}">
                                </a>
                                <a class="J_menuItem" href="x_personal_page_show_demo.html" title="HZ">
                                    <img alt="image" class="img-circle" src="{% static "img/a4.jpg" %}">
                                </a>
                                <a class="J_menuItem" href="x_personal_page_show_demo.html" title="CRM">
                                    <img alt="image" class="img-circle" src="{% static "img/a5.jpg" %}">
                                </a>

                            </ui>
                        </ul>
                    </li>

                </ul>
                </li>
                </ul>
            </div>
        </nav>
        <!--左侧导航结束-->
        <!--右侧部分开始-->
        <div class="small-chat-box fadeInRight animated" onload="Recieve()">

            <div class="heading" draggable="true">
                <p>与 Beau-zihan 聊天中</p>
            </div>

            <div class="content" id = "chatshow"></div>


            <div class="form-chat">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="chatinput">
                    <span class="input-group-btn">
                <button class="btn btn-info" type="button" onclick="talk()" id="chatsub">发送
                </button>
            </span>
                </div>
            </div>

        </div>

        <div id="friendlist" class="friendlist animated fadeInLeft" >
            <div class="heading">
                <h4 >好友列表</h4>
            </div>
            <div class="content" onclick="Update_i(event);Clear_tab(event);">
                <ul class="sortable-list connectList agile-list" style="height: 275px;overflow: auto;">
                    {% for friend in friend_list %}
                        <li  id="friend" class="info-element" onclick="Getid(event);Justice();Alljustice();Justice()">
                            <img class="img-circle" src="{% get_media_prefix %}{{ friend.portrait }}" style="width: 30px">
                            <h5 class="pull-right" style="text-align: center;">{{ friend.username }}</h5>
                        </li>
                    {% endfor %}

                </ul>
            </div>
        </div>
        <script>
                    function changeid() {
                    var i;
                    for(i=1;i<={{ friend_list | length }};i++){
                        document.getElementById("friend").id = "friend" + i;
                    }
                }

                    changeid();
        </script>

        <div id="small-chat" onclick="firstactive2()">
            <span class="badge badge-danger pull-right">...</span>
            <a class="open-small-chat" onclick="firstactive2()">
                <i class="fa fa-comments" onclick="firstactive2()"></i>
            </a>
        </div>


        <div id="page-wrapper" class="gray-bg dashbard-1">

            <div class="row border-bottom">
                <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
                    <div class="navbar-header"><a class="navbar-minimalize minimalize-styl-2 btn btn-success " href="#"><i class="fa fa-bars"></i> </a>
                        <form role="search" class="navbar-form-custom" method="get" action="/search">
                            <div class="form-group" >
                                <input name='q' type="text" placeholder="请输入您需要查找的内容 …(回车)" class="form-control" id="top-search" >
                            </div>
                        </form>
                    </div><!--搜索-->

{#                    <ul class="nav navbar-top-links navbar-right">#}
{#                        <li class="dropdown">#}
{#                            <a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">#}
{#                                <i class="fa fa-envelope"></i> <span class="label label-warning">16</span>#}
{#                            </a>#}
{#                            <ul class="dropdown-menu dropdown-messages">#}
{#                                <li class="m-t-xs">#}
{#                                    <div class="dropdown-messages-box">#}
{#                                        <a href="x_personal_page_show_demo.html" class="pull-left">#}
{#                                            <img alt="image" class="img-circle" src="{% static "img/a7.jpg" %}">#}
{#                                        </a>#}
{#                                        <div class="media-body">#}
{#                                            <small class="pull-right">46小时前</small>#}
{#                                            <strong>用户二</strong> 读书笔记到底要交几篇？#}
{#                                            <br>#}
{#                                            <small class="text-muted">3天前 2016.11.8</small>#}
{#                                 var Words = document.getElementById("chatshow");#}
{#           </div>#}
{#                                    </div>#}
{#                                </li>#}
{#                                <li class="divider"></li>#}
{#                                <li>#}
{#                                    <div class="dropdown-messages-box">#}
{#                                        <a href="x_personal_page_show_demo.html" class="pull-left">#}
{#                                            <img alt="image" class="img-circle" src="{% static "img/a4.jpg" %}">#}
{#                                        </a>#}
{#                                        <div class="media-body ">#}
{#                                            <small class="pull-right text-navy">25小时前</small>#}
{#                                            <strong>用户一</strong> 软工ddl延期#}
{#                                            <br>#}
{#                                            <small class="text-muted">昨天</small>#}
{#                                        </div>#}
{#                                    </div>#}
{#                                </li>#}
{#                                <li class="divider"></li>#}
{#                                <li>#}
{#                                    <div class="text-center link-block">#}
{#                                        <a class="J_menuItem" href="x_mailbox_demo.html">#}
{#                                            <i class="fa fa-envelope"></i> <strong> 查看所有消息</strong>#}
{#                                        </a>#}
{#                                    </div>#}
{#                                </li>#}
{#                            </ul>#}
{#                        </li>#}
                    </ul><!--右侧组件-->
                </nav>
            </div><!--顶部搜索导航栏-->

            <div class="row content-tabs">
                <button class="roll-nav roll-left J_tabLeft"><i class="fa fa-backward"></i>
                </button>
                <nav class="page-tabs J_menuTabs">
                    <div class="page-tabs-content">
                        <a href="javascript:;" class="active J_menuTab" data-id="x_BBS_index_demo.html">首页</a>
                    </div>
                </nav>
                <button class="roll-nav roll-right J_tabRight"><i class="fa fa-forward"></i>
                </button>
                <div class="btn-group roll-nav roll-right">
                    <button class="dropdown J_tabClose" data-toggle="dropdown">关闭操作<span class="caret"></span>

                    </button>
                    <ul role="menu" class="dropdown-menu dropdown-menu-right">
                        <li class="J_tabShowActive"><a>定位当前选项卡</a>
                        </li>
                        <li class="divider"></li>
                        <li class="J_tabCloseAll"><a>关闭全部选项卡</a>
                        </li>
                        <li class="J_tabCloseOther"><a>关闭其他选项卡</a>
                        </li>
                    </ul>
                </div>
                <a href="{% url "logout" %}" class="roll-nav roll-right J_tabExit"><i class="fa fa fa-sign-out"></i> 退出</a>
            </div>
            <div class="row J_mainContent" id="content-main">
                <iframe class="J_iframe" name="iframe0" width="100%" height="100%" src={% url "index_core" %} frameborder="0" data-id="x_BBS_index_demo.html" seamless></iframe>
            </div>
            <div class="footer">
                <div class="pull-right">&copy; 2018 <a href="" target="_blank">攻城喵</a>
                </div>
            </div>
        </div>

        <!--右侧部分结束-->
    </div>

    <!-- 全局js -->
{#    <script src="js/jquery.min.js?v=2.1.4"></script>#}
{#    <script src="js/bootstrap.min.js?v=3.3.6"></script>#}
{#    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>#}
{#    <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>#}
{#    <script src="js/plugins/layer/layer.min.js"></script>#}
{##}
{#    <!-- 自定义js -->#}
{#    <script src="js/hplus.js?v=4.1.0"></script>#}
{#    <script type="text/javascript" src="js/contabs.js"></script>#}
{##}
{#    <!-- 第三方插件 -->#}
{#    <script src="js/plugins/pace/pace.min.js"></script>#}
{% include "js_use.html" %}
    <script language= "JavaScript">
        function keyEnter(){
            if (event.keyCode == 13) {
                talk();
            }
        }
        document.onkeydown = keyEnter;
    </script>

    <script>
        var roomName = {{ room_name_json }};

        var room_name_list = {{ room_name_list }};

        var i;

        var chatSocket = {};

        for( i in room_name_list) {

                chatSocket[i] = new WebSocket(
                'ws://' + window.location.host +
                '/ws/chat/' + room_name_list[i] + '/');

            chatSocket[i].onmessage = function(e) {
                var data = JSON.parse(e.data);
                var message = data['message'];
                var user = data['user'];
                var time = data['time'];
                var is_user = data['is_user'];
                console.log(message + user + time + is_user);
                var Words = document.getElementById("chatshow");
                var str = "";
                console.log(message);
                {#document.querySelector('#zhmsgtest').innerHTML = message;#}

                if(is_user == false){
                    str =   '<div class="left">' +
                        '<div class="author-name">' +
                        '<strong>'+user+'</strong>' +
                        '<small class="chat-date">' +
                        time +
                        '</small>' +
                        '</div>' +
                        '<div class="chat-message active">' +
                        message +
                        '</div>' +
                        '</div>'
                        +'<br>';
                }
                else{
                    str =   '<div class="right">' +
                        '<div class="author-name">' +
                        '<strong>'+'我'+'</strong>' +
                        '<small class="chat-date">' +
                        time +
                        '</small>' +
                        '</div>' +
                        '<div class="chat-message active">' +
                        message +
                        '</div>' +
                        '</div>'
                        +'<br>';
                }


                if (str != "") {
                    Words.innerHTML = Words.innerHTML + str;
                    Words.scrollTop = Words.scrollHeight;
                }

            };

            chatSocket.onclose = function(e) {
                {#console.error('Chat socket closed unexpectedly');#}
            };

            function Update_i(ev) {
                if(ev.target.tagName.toUpperCase() !== "LI") {
                    i = ev.target.parentNode.id;
                }
                else {
                    i = ev.target.id;
                }
                console.log(i)
            }

            function Clear_tab(ev) {
                document.getElementById("chatshow").innerHTML = "";
                chatSocket[i[6]-1].send("/plaese/send/me/the/log")

            }

            document.querySelector('#chatinput').focus();
            document.querySelector('#chatinput').onkeyup = function(e) {
                if (e.keyCode === 13) {  // enter, return
                    document.querySelector('#chatsub').click();
                }
            };


            document.querySelector('#chatsub').onclick = function(e) {
                var messageInputDom = document.querySelector('#chatinput');
                var message = messageInputDom.value;
                var j = i[6];
                console.log(chatSocket[j-1]);
                chatSocket[j-1].send(JSON.stringify({
                    'message': message
                }));

                messageInputDom.value = '';
            };
        }




    </script>
</body>

</html>
